name: build

on:
  push:
  pull_request:
  workflow_dispatch:
    inputs:
      deploy_linux_amd64:
        description: 'Deploy Linux amd64'
        type: boolean
        default: true
      deploy_windows_amd64:
        description: 'Deploy Windows amd64'
        type: boolean
        default: true
      deploy_darwin_amd64:
        description: 'Deploy macOS Intel'
        type: boolean
        default: true
      deploy_darwin_arm64:
        description: 'Deploy macOS ARM64'
        type: boolean
        default: true

jobs:
  build:
    name: Build (${{ matrix.name }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: linux
            os: ubuntu-22.04
            arch: x86_64
          - name: windows
            os: windows-latest
            arch: x86_64
          - name: macos-intel
            os: macos-15-intel
            arch: x86_64
          - name: macos-arm64
            os: macos-latest
            arch: arm64

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version-file: 'go.mod'

    - name: Linux dependencies
      if: matrix.name == 'linux'
      run: sudo apt-get install -y libpango1.0-dev libpangocairo-1.0-0 libgdk-pixbuf2.0-dev libgtk-3-dev

    - name: Setup
      run: npm ci --no-audit

    - name: Build
      run: node release/build.js --arch ${{ matrix.arch }} --skip-signing

    - name: Store
      uses: actions/upload-artifact@v4
      with:
        name: binaries-${{ matrix.name }}
        path: artifacts/

  sign-windows:
    name: Sign Windows
    if: github.event_name == 'workflow_dispatch' && inputs.deploy_windows_amd64
    needs: build
    runs-on: windows-latest
    environment: signing-windows
    permissions:
      id-token: write
    steps:
    - name: Download artifacts
      uses: actions/download-artifact@v4
      with:
        name: binaries-windows
        path: artifacts/

    - name: Sign with Azure Trusted Signing
      uses: azure/artifact-signing-action@v1
      with:
        azure-tenant-id: ${{ secrets.AZURE_TENANT_ID }}
        azure-client-id: ${{ secrets.AZURE_CLIENT_ID }}
        azure-client-secret: ${{ secrets.AZURE_CLIENT_SECRET }}
        endpoint: https://wus2.codesigning.azure.net
        signing-account-name: itchio
        certificate-profile-name: itchio
        files-folder: artifacts/
        files-folder-filter: exe
        files-folder-recurse: true

    - name: Upload signed artifacts
      uses: actions/upload-artifact@v4
      with:
        name: binaries-windows-signed
        path: artifacts/

  sign-darwin:
    name: Sign macOS (${{ matrix.name }})
    if: github.event_name == 'workflow_dispatch'
    needs: build
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: macos-intel
            runner: macos-15-intel
            arch: amd64
            deploy_input: deploy_darwin_amd64
          - name: macos-arm64
            runner: macos-latest
            arch: arm64
            deploy_input: deploy_darwin_arm64
    runs-on: ${{ matrix.runner }}
    environment: signing-macos
    steps:
    - name: Check if deployment enabled
      id: check
      run: |
        if [[ "${{ matrix.deploy_input }}" == "deploy_darwin_amd64" ]]; then
          echo "enabled=${{ inputs.deploy_darwin_amd64 }}" >> $GITHUB_OUTPUT
        else
          echo "enabled=${{ inputs.deploy_darwin_arm64 }}" >> $GITHUB_OUTPUT
        fi

    - name: Download artifacts
      if: steps.check.outputs.enabled == 'true'
      uses: actions/download-artifact@v4
      with:
        name: binaries-${{ matrix.name }}
        path: artifacts/

    - name: Restore execute permissions
      if: steps.check.outputs.enabled == 'true'
      run: |
        BINARY="artifacts/itch-setup/darwin-${{ matrix.arch }}/itch-setup"
        if [ -f "$BINARY" ]; then
          echo "Restoring +x on $BINARY"
          chmod +x "$BINARY"
        fi

    - name: Import signing certificate
      if: steps.check.outputs.enabled == 'true'
      env:
        APPLE_CERTIFICATE_P12_BASE64: ${{ secrets.APPLE_CERTIFICATE_P12_BASE64 }}
        APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
      run: |
        # Create temporary keychain
        KEYCHAIN_PATH=$RUNNER_TEMP/signing.keychain-db
        KEYCHAIN_PASSWORD=$(openssl rand -base64 32)

        security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
        security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
        security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

        # Import certificate
        CERT_PATH=$RUNNER_TEMP/certificate.p12
        echo "$APPLE_CERTIFICATE_P12_BASE64" | base64 --decode > "$CERT_PATH"
        security import "$CERT_PATH" -P "$APPLE_CERTIFICATE_PASSWORD" -A -t cert -f pkcs12 -k "$KEYCHAIN_PATH"
        rm "$CERT_PATH"

        # Set keychain search list
        security list-keychain -d user -s "$KEYCHAIN_PATH"

        # Allow codesign to access the keychain
        security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

    - name: Sign binary
      if: steps.check.outputs.enabled == 'true'
      run: |
        SIGN_KEY="Developer ID Application: itch corp. (AK2D34UDP2)"
        BINARY="artifacts/itch-setup/darwin-${{ matrix.arch }}/itch-setup"
        if [ -f "$BINARY" ]; then
          echo "Signing $BINARY..."
          codesign --deep --force --verbose --options runtime --sign "$SIGN_KEY" "$BINARY"
          codesign --verify -vvvv "$BINARY"
        fi

    - name: Notarize binary
      if: steps.check.outputs.enabled == 'true'
      env:
        APPLE_ID: ${{ secrets.APPLE_ID }}
        APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
        APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
      run: |
        BINARY="artifacts/itch-setup/darwin-${{ matrix.arch }}/itch-setup"
        if [ -f "$BINARY" ]; then
          echo "Notarizing $BINARY..."

          # Create a zip for notarization
          ZIP_PATH="${BINARY}.zip"
          ditto -c -k --keepParent "$BINARY" "$ZIP_PATH"

          # Submit for notarization and capture output
          NOTARY_OUTPUT=$(xcrun notarytool submit "$ZIP_PATH" \
            --apple-id "$APPLE_ID" \
            --password "$APPLE_APP_SPECIFIC_PASSWORD" \
            --team-id "$APPLE_TEAM_ID" \
            --wait 2>&1)

          echo "$NOTARY_OUTPUT"

          # Check if notarization was successful
          if echo "$NOTARY_OUTPUT" | grep -q "status: Accepted"; then
            echo "Notarization successful for itch-setup"
          else
            echo "Notarization failed for itch-setup"
            # Get the submission ID and fetch the log
            SUBMISSION_ID=$(echo "$NOTARY_OUTPUT" | grep "id:" | head -1 | awk '{print $2}')
            if [ -n "$SUBMISSION_ID" ]; then
              echo "Fetching notarization log..."
              xcrun notarytool log "$SUBMISSION_ID" \
                --apple-id "$APPLE_ID" \
                --password "$APPLE_APP_SPECIFIC_PASSWORD" \
                --team-id "$APPLE_TEAM_ID" || true
            fi
            exit 1
          fi

          # Clean up zip
          rm "$ZIP_PATH"
        fi

    - name: Upload signed artifacts
      if: steps.check.outputs.enabled == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: binaries-${{ matrix.name }}-signed
        path: artifacts/

  deploy:
    name: Deploy
    if: |
      always() &&
      github.event_name == 'workflow_dispatch' &&
      needs.build.result == 'success' &&
      (needs.sign-windows.result == 'success' || needs.sign-windows.result == 'skipped') &&
      (needs.sign-darwin.result == 'success' || needs.sign-darwin.result == 'skipped')
    needs: [build, sign-windows, sign-darwin]
    runs-on: ubuntu-latest
    environment: production
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    # Linux artifacts (no signing needed)
    - name: Download Linux artifacts
      if: inputs.deploy_linux_amd64
      uses: actions/download-artifact@v4
      with:
        name: binaries-linux
        path: artifacts/

    # Signed Windows artifacts
    - name: Download signed Windows artifacts
      if: inputs.deploy_windows_amd64
      uses: actions/download-artifact@v4
      with:
        name: binaries-windows-signed
        path: artifacts/

    # Signed macOS artifacts
    - name: Download signed macOS Intel artifacts
      if: inputs.deploy_darwin_amd64
      uses: actions/download-artifact@v4
      with:
        name: binaries-macos-intel-signed
        path: artifacts/

    - name: Download signed macOS ARM64 artifacts
      if: inputs.deploy_darwin_arm64
      uses: actions/download-artifact@v4
      with:
        name: binaries-macos-arm64-signed
        path: artifacts/

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Install dependencies
      run: npm ci --no-audit

    - name: Deploy to itch.io
      env:
        BUTLER_API_KEY: ${{ secrets.BUTLER_API_KEY }}
      run: node release/deploy.js
